<script setup lang="ts">
import { ref, computed } from 'vue'
import { useRouter } from 'vue-router'
import ToolCard from '@/components/ToolCard.vue'
import TopNav from '@/components/TopNav.vue'

const router = useRouter()
const currentCategory = ref('all')
const searchQuery = ref('')

const handleToolClick = (tool: any) => {
  if (tool.title === 'å­¦ç”Ÿæˆç»©èšç±»åˆ†æ') {
    router.push('/chat/grade')
  } else if (tool.title === 'æˆéƒ½å¤§å­¦æ•™åŠ¡ç®¡ç†') {
    window.location.href = 'http://localhost/chat/uLKfjGrUiyBVOVAJ'
  } else if (tool.title === 'å°å­¦åˆ¶åº¦ç®¡ç†') {
    window.location.href = 'http://localhost/chat/jHqO56xfCK5PQ8l3'
  } else if (tool.title === 'Excelå›¾è¡¨ç”Ÿæˆ') {
    window.location.href = 'http://localhost/workflow/GQDvfSiyyn1jF8rs'
  } else if (tool.title === 'æ€ç»´å¯¼å›¾') {
    window.location.href = 'http://localhost/workflow/OZLqjEQZqWOVjGas'
  } else if (tool.title === 'æ•°å­¦ä½œä¸šæ‰¹æ”¹') {
    window.location.href = 'http://localhost/workflow/Bi34hrrdFRQrJmwR'
  } else if (tool.title === 'ä½œæ–‡æ‰¹æ”¹') {
    window.location.href = 'http://localhost/workflow/ffJmJeYxtvpzvzNM'
  } else if (tool.title === 'ç†è§£å›¾ç‰‡') {
    window.location.href = 'http://localhost/workflow/JByJwlOBETph2VGf'
  } else if (tool.title === 'æ–‡ç”Ÿå›¾æ–‡æ•…äº‹') {
    window.location.href = 'http://localhost/chat/yWP3jhWTOaqlnseZ'
  } else if (tool.title === 'Excelå¤šå›¾è¡¨å‘ˆç°') {
    window.location.href = 'http://localhost/workflow/hKNLer93F2YnC69Y'
  } else if (tool.title === 'ç”Ÿæˆè¯•å·') {
    window.location.href = 'http://localhost/chat/Ct55aFwxta1bsJQO'
  } else if (tool.title === 'æˆéƒ½å¤§å­¦è´¢åŠ¡ç®¡ç†') {
    window.location.href = 'http://localhost/chat/qmduTC01qRRGsdRT'
  } else if (tool.title === 'æ–‡ä»¶åˆ†å‰²') {
    window.location.href = 'http://localhost/workflow/OhvSGzNiXzYIshIx'
  } else if (tool.title === 'æ•°æ®åº“æ•°æ®è¯»å–ä¸åˆ†æ') {
    window.location.href = 'http://localhost/workflow/U4KQBlbGwdudnYnt'
  } else if (tool.title === 'æ™ºèƒ½ä½“') {
    window.location.href = 'http://localhost/workflow/m0MwT2zqCgsIH1wY'
  }
}

const tools = [
  // æ•™å­¦åŠ©æ‰‹
  {
    icon: 'âœï¸',
    title: 'æ•°å­¦ä½œä¸šæ‰¹æ”¹',
    description: 'æ™ºèƒ½æ‰¹æ”¹æ•°å­¦ä½œä¸š',
    isNew: true,
    category: 'teaching'
  },
  {
    icon: 'ğŸ“',
    title: 'ä½œæ–‡æ‰¹æ”¹',
    description: 'æ™ºèƒ½æ‰¹æ”¹ä½œæ–‡',
    isNew: true,
    category: 'teaching'
  },
  {
    icon: 'ğŸ“„',
    title: 'ç”Ÿæˆè¯•å·',
    description: 'æ™ºèƒ½ç”Ÿæˆè¯•å·',
    isNew: true,
    category: 'teaching'
  },
  // å­¦ç”ŸåŠ©æ‰‹
  {
    icon: 'ğŸ–¼ï¸',
    title: 'ç†è§£å›¾ç‰‡',
    description: 'æ™ºèƒ½ç†è§£å›¾ç‰‡å†…å®¹',
    isNew: true,
    category: 'student'
  },
  {
    icon: 'ğŸ“–',
    title: 'æ–‡ç”Ÿå›¾æ–‡æ•…äº‹',
    description: 'æ ¹æ®æ–‡å­—ç”Ÿæˆå›¾æ–‡æ•…äº‹',
    isNew: true,
    category: 'student'
  },
  {
    icon: 'ğŸ§ ',
    title: 'æ€ç»´å¯¼å›¾',
    description: 'æ™ºèƒ½ç”Ÿæˆæ€ç»´å¯¼å›¾',
    isNew: true,
    category: 'student'
  },
  // ç®¡ç†åŠ©æ‰‹
  {
    icon: 'ğŸ«',
    title: 'æˆéƒ½å¤§å­¦æ•™åŠ¡ç®¡ç†',
    description: 'æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ',
    isNew: true,
    category: 'management'
  },
  {
    icon: 'ğŸ’°',
    title: 'æˆéƒ½å¤§å­¦è´¢åŠ¡ç®¡ç†',
    description: 'è´¢åŠ¡ç®¡ç†ç³»ç»Ÿ',
    isNew: true,
    category: 'management'
  },
  {
    icon: 'ğŸ“‹',
    title: 'å°å­¦åˆ¶åº¦ç®¡ç†',
    description: 'å°å­¦ç®¡ç†åˆ¶åº¦',
    isNew: true,
    category: 'management'
  },
  // è¯„ä»·åŠ©æ‰‹
  {
    icon: 'ğŸ“Š',
    title: 'Excelå›¾è¡¨ç”Ÿæˆ',
    description: 'æ™ºèƒ½ç”ŸæˆExcelå›¾è¡¨',
    isNew: true,
    category: 'evaluation'
  },
  {
    icon: 'ğŸ“Š',
    title: 'Excelå¤šå›¾è¡¨å‘ˆç°',
    description: 'å¤šç»´åº¦æ•°æ®å›¾è¡¨å±•ç¤º',
    isNew: true,
    category: 'evaluation'
  },
  {
    icon: 'ğŸ“ˆ',
    title: 'å­¦ç”Ÿæˆç»©èšç±»åˆ†æ',
    description: 'æ™ºèƒ½åˆ†æå­¦ç”Ÿæˆç»©æ•°æ®',
    isNew: true,
    category: 'evaluation'
  },
  // å·¥å…·
  {
    icon: 'âœ‚ï¸',
    title: 'æ–‡ä»¶åˆ†å‰²',
    description: 'æ™ºèƒ½æ–‡ä»¶åˆ†å‰²',
    isNew: true,
    category: 'tools'
  },
  {
    icon: 'ğŸ’¾',
    title: 'æ•°æ®åº“æ•°æ®è¯»å–ä¸åˆ†æ',
    description: 'æ•°æ®åº“æ•°æ®åˆ†æ',
    isNew: true,
    category: 'tools'
  },
  {
    icon: 'ğŸ¤–',
    title: 'æ™ºèƒ½ä½“',
    description: 'æ™ºèƒ½ä½“æœåŠ¡',
    isNew: true,
    category: 'tools'
  }
]

const filteredTools = computed(() => {
  let result = tools
  
  // æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤
  const userRole = localStorage.getItem('userInfo') 
    ? JSON.parse(localStorage.getItem('userInfo')!).role 
    : 'student'
  
  result = result.filter(tool => {
    if (userRole === 'admin') return true
    if (userRole === 'teacher') return ['teaching', 'evaluation'].includes(tool.category)
    if (userRole === 'student') return tool.category === 'student'
    return false
  })
  
  // å¦‚æœæœç´¢æ¡†æœ‰å†…å®¹ï¼Œåªä½¿ç”¨æœç´¢è¿‡æ»¤
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    return result.filter(tool => 
      tool.title.toLowerCase().includes(query) || 
      tool.description.toLowerCase().includes(query)
    )
  }
  
  // å¦‚æœæ²¡æœ‰æœç´¢å†…å®¹ï¼Œä½¿ç”¨åˆ†ç±»è¿‡æ»¤
  if (currentCategory.value !== 'all') {
    result = result.filter(tool => tool.category === currentCategory.value)
  }
  
  return result
})

const handleCategoryChange = (category: string) => {
  currentCategory.value = category
  searchQuery.value = '' // æ¸…é™¤æœç´¢å†…å®¹
}

const handleSearch = (query: string) => {
  searchQuery.value = query
  if (query) {
    currentCategory.value = 'all' // å½“æœ‰æœç´¢å†…å®¹æ—¶ï¼Œé‡ç½®åˆ†ç±»ä¸º"å…¨éƒ¨"
  }
}
</script>

<template>
  <div class="discover-view">
    <TopNav 
      @categoryChange="handleCategoryChange" 
      @search="handleSearch"
    />
    <div class="tools-grid">
      <ToolCard
        v-for="tool in filteredTools"
        :key="tool.title"
        v-bind="tool"
        class="tool-card"
        @click="handleToolClick(tool)"
      />
    </div>
  </div>
</template>

<style scoped>
.discover-view {
  padding: 20px;
}

.tools-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-top: 20px;
}

@media (max-width: 1200px) {
  .tools-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .tools-grid {
    grid-template-columns: 1fr;
  }
}

.tool-card {
  background: white;
  border-radius: 8px;
  transition: all 0.3s;
}

.tool-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
</style> 